import requests
import pandas as pd
from ics import Calendar, Event
from datetime import datetime
from io import BytesIO

# 1. Ссылка на расписание (xlsx)
URL = "https://timetable.spbu.ru/EARTH/StudentGroupEvents/DownloadExcel/427997?Length=18"

# 2. Скачиваем Excel
response = requests.get(URL)
response.raise_for_status()
excel_data = BytesIO(response.content)

# 3. Загружаем в pandas
df = pd.read_excel(excel_data)

# Ожидается, что в файле есть колонки с датами/временем и названием занятий
# Нужно подстроить под структуру файла СПбГУ
# Пример: "Дата", "Начало", "Конец", "Дисциплина", "Аудитория"
# В реальности названия колонок уточняем после первого запуска
calendar = Calendar()

for _, row in df.iterrows():
    try:
        start_str = f"{row['Дата']} {row['Начало']}"
        end_str   = f"{row['Дата']} {row['Конец']}"
        start = datetime.strptime(start_str, "%d.%m.%Y %H:%M")
        end   = datetime.strptime(end_str, "%d.%m.%Y %H:%M")

        event = Event()
        event.name = str(row['Дисциплина'])
        event.begin = start
        event.end = end
        event.location = str(row['Аудитория'])
        calendar.events.add(event)
    except Exception as e:
        print("Ошибка обработки строки:", e)

# 4. Сохраняем .ics
with open("schedule.ics", "w", encoding="utf-8") as f:
    f.writelines(calendar.serialize_iter())
